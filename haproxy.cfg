global
    daemon
    log stdout local0 info
    
    # Performance tuning
    maxconn 4096
    spread-checks 4
    tune.ssl.default-dh-param 2048
    
    # Security - removed chroot for Docker compatibility
    # chroot /var/lib/haproxy  # Disabled for Docker
    # user haproxy             # Disabled for Docker
    # group haproxy            # Disabled for Docker
    
defaults
    mode tcp
    retries 3
    option redispatch
    option tcplog
    option log-health-checks
    option dontlognull
    option tcp-smart-accept
    option tcp-smart-connect
    
    # Optimized timeouts for MySQL/Galera
    timeout connect 3000ms
    timeout client 28800000ms  # 8 hours for long-running queries
    timeout server 28800000ms  # 8 hours for long-running queries
    timeout check 5000ms
    timeout queue 5000ms
    
    # Connection management
    option tcp-check
    default-server inter 1000ms fastinter 100ms downinter 5000ms rise 2 fall 3

# Galera cluster health check endpoint
# Simple HTTP health check that returns cluster status
frontend galera-health-check
    bind :9200
    mode http
    
    # Always return 200 OK for basic connectivity check
    http-request return status 200 content-type "application/json" string '{"status":"ok","cluster":"galera"}'

# General purpose backend
backend galera-backend
    balance leastconn
    option mysql-check user haproxy_check
    
    # Enhanced health checking with Galera-specific parameters
    server galera-node1 galera-node1:3306 check port 3306 maxconn 200 weight 100
    server galera-node2 galera-node2:3306 check port 3306 maxconn 200 weight 100
    server galera-node3 galera-node3:3306 check port 3306 maxconn 200 weight 100
    # Keep node4 as backup for high availability
    server galera-node4 galera-node4:3306 check port 3306 maxconn 200 weight 100 backup

# MySQL frontend
frontend galera-frontend
    bind *:3306
    maxconn 2048
    
    default_backend galera-backend

# Enhanced statistics page
frontend stats
    bind *:8080
    mode http
    maxconn 50
    
    # Basic auth for stats (optional, uncomment and configure)
    # stats auth admin:secure_password_here
    
    stats enable
    stats uri /stats
    stats refresh 10s
    stats hide-version
    stats show-legends
    stats show-desc "Galera Cluster Load Balancer"
